<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
   <script src="https://cdnjs.cloudflare.com/ajax/libs/mithril/1.1.6/mithril.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <script src="https://kit.fontawesome.com/6a52086692.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <title>JCode AI</title>
    <style>
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="app"></div>
    <script>
      const app = {
        state: {
          activeTab: 'edit',
          text: '',
          sentences: [],
          currentSentence: [],
          userSentence: [],
          correctSentence: [],
          score: 0,
          learning: false,
          message: '',
        },
         setActiveTab: function(tab) {
          this.state.activeTab = tab;
        },
        setText: function(text) {
          this.state.text = text;
          this.processText();
        },
        processText: function() {
          const sentences = this.state.text.match(/[^.!?]+[.!?]+/g) || [];
          this.state.sentences = sentences.map(sentence => sentence.split(/\s+/)).reduce(
            (acc, current) => {
              if (current.length < 5 && 0 < acc.length) {
                acc[acc.length - 1] += current;
              } else if (0 < current.length) {
                acc.push(current);
              }
              return acc;
            },
            []
          );
          this.state.correctSentence = this.state.sentences.shift() || [];
          this.state.currentSentence = [...this.state.correctSentence]; // Store the correct sentence
          this.shuffleSentence();
        },
        shuffleSentence: function() {
          this.state.currentSentence.sort();
          this.state.userSentence = [];
        },
        addToUserSentence: function(word, index) {
          this.state.userSentence.push(word);
          this.state.currentSentence.splice(index, 1);
        },
        removeFromUserSentence: function(word, index) {
          this.state.currentSentence.push(word);
          this.state.userSentence.splice(index, 1);
        },
        checkOrder: function() {
          const correct = this.state.userSentence.join(' ') === this.state.correctSentence.join(' ');
          if (correct) {
            this.state.score += 1;
            this.state.correctSentence = this.state.sentences.shift() || [];
            this.state.currentSentence = [...this.state.correctSentence]; // Store the correct sentence
            if (this.state.correctSentence.length === 0) {
              this.state.message = 'Congratulations! You have completed the exercise!';
            } else {
              this.shuffleSentence();
            }
          } else {
            console.log('Incorrect', this.state.userSentence, this.state.correctSentence);
            // Find the index of the first incorrect word
            let incorrectIndex = 0;
            for (let i = 0; i < this.state.userSentence.length; i++) {
              if (this.state.userSentence[i] !== this.state.correctSentence[i]) {
                incorrectIndex = i;
                break;
              }
            }

            // Move incorrect words back to currentSentence
            for (let i = this.state.userSentence.length - 1; i >= incorrectIndex; i--) {
              const word = this.state.userSentence[i];
              this.state.currentSentence.push(word);
              this.state.userSentence.splice(i, 1);
            }
          }
        },
        view: function() {
          let message = '';
          if (this.state.activeTab === 'edit') {
            message = this.state.text === '' ? 'Enter text to get started!' : 'Go to the ‘Learn’ tab to start learning!';
          } else if (this.state.activeTab === 'learn') {
            message = 'Click on the words in the right order to make the sentence.';
          }
          if (this.state.message) {
            message = this.state.message;
          }

          return m('div', { class: 'section' }, [
            m('div', { class: 'tabs is-centered' },
              m('ul', [
                m('li', { class: this.state.activeTab === 'edit' ? 'is-active' : '' },
                  m('a', { onclick: () => this.setActiveTab('edit') }, 'Edit')
                ),
                m('li', { class: this.state.activeTab === 'learn' ? 'is-active' : '' },
                  m('a', { onclick: () => this.setActiveTab('learn') }, 'Learn')
                )
              ])
            ),
            m('div', { class: 'container' }, [
              this.state.activeTab === 'edit' ?
                m('textarea', {
                  class: 'textarea',
                  value: this.state.text,
                  oninput: m.withAttr('value', this.setText.bind(this)),
                  placeholder: 'Paste your text here...'
                })
                : null,
              this.state.activeTab === 'learn' ?
                m('div', [
                  m('div', { class: 'mb-4' }, [
                    m('div', { class: 'flex flex-wrap gap-2 mb-2' }, this.state.userSentence.map((word, index) =>
                      m('button', {
                        class: 'button is-info',
                        onclick: () => this.removeFromUserSentence(word, index)
                      }, word)
                    )),
                    m('div', { class: 'flex flex-wrap gap-2' }, this.state.currentSentence.map((word, index) =>
                      m('button', {
                        class: 'button is-light',
                        onclick: () => this.addToUserSentence(word, index)
                      }, word)
                    ))
                  ]),
                  m('button', {
                    class: 'button is-success mb-4',
                    onclick: this.checkOrder.bind(this),
                    disabled: this.state.correctSentence.length === 0 || this.state.currentSentence.length > 0
                  }, 'Check Order'),
                  m('p', `Score: ${this.state.score}`)
                ])
                : null
            ]),
            m('div', {class: 'message'},
              m('div', {class: 'message-body'}, message)
            )
          ]);
        }
      };

      m.mount(document.getElementById('app'), app);
    </script>
  </body>
</html>
